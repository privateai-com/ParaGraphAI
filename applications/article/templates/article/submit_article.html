{% extends "base.html" %} {% load static %} {% load i18n %} {% block title %}{% trans 'Добавить статью' %}{% endblock %} {% block extra_head %}
<style></style>
{% endblock %} {% block content %}
<div id="notifications-wrapper">
  <div id="notifications">
    <p style="text-align: center; color: #6c757d; margin: 5px 0">{% trans 'Waiting for notifications...' %}</p>
  </div>
  <button id="notifications-toggle-button">
    <svg class="toggle-button-closed-svg" width="24" height="24" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
      <g filter="url(#filter0_d_8537_320451)">
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M6.00066 9C6.00066 7.14348 6.73816 5.36301 8.05092 4.05025C9.36367 2.7375 11.1441 2 13.0007 2C14.8572 2 16.6377 2.7375 17.9504 4.05025C19.2632 5.36301 20.0007 7.14348 20.0007 9V12.764L21.8227 16.408C21.9065 16.5757 21.9461 16.7621 21.9377 16.9494C21.9293 17.1368 21.8731 17.3188 21.7745 17.4783C21.6759 17.6379 21.5382 17.7695 21.3744 17.8608C21.2106 17.9521 21.0262 18 20.8387 18H16.8747C16.6522 18.8582 16.1511 19.6183 15.4499 20.1609C14.7488 20.7035 13.8873 20.9979 13.0007 20.9979C12.1141 20.9979 11.2526 20.7035 10.5514 20.1609C9.85023 19.6183 9.3491 18.8582 9.12666 18H5.16266C4.97514 18 4.79072 17.9521 4.62693 17.8608C4.46314 17.7695 4.3254 17.6379 4.22681 17.4783C4.12822 17.3188 4.07204 17.1368 4.06361 16.9494C4.05518 16.7621 4.09479 16.5757 4.17866 16.408L6.00066 12.764V9ZM11.2687 18C11.4442 18.304 11.6967 18.5565 12.0007 18.732C12.3047 18.9075 12.6496 18.9999 13.0007 18.9999C13.3517 18.9999 13.6966 18.9075 14.0006 18.732C14.3046 18.5565 14.5571 18.304 14.7327 18H11.2687ZM13.0007 4C11.6746 4 10.4028 4.52678 9.46513 5.46447C8.52745 6.40215 8.00066 7.67392 8.00066 9V12.764C8.00064 13.0743 7.9284 13.3804 7.78966 13.658L6.61966 16H19.3827L18.2127 13.658C18.0736 13.3805 18.001 13.0744 18.0007 12.764V9C18.0007 7.67392 17.4739 6.40215 16.5362 5.46447C15.5985 4.52678 14.3267 4 13.0007 4Z"
          fill="black"
        ></path>
      </g>
    </svg>
    <svg class="toggle-button-opened-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="..." fill="black" />
    </svg>
  </button>
</div>

<div class="container">
  <div class="form-container-contained">
    <h2>{% trans 'Add or Update Article' %}</h2>
    
    <!-- User-friendly explanation section -->
    <div class="explanation-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid var(--primary-color);">
      <h3 style="color: var(--primary-color); margin-top: 0;">{% trans 'How it works' %}</h3>
      <p style="margin-bottom: 15px;">{% trans 'We help you analyze scientific articles from biomedical and life sciences research. Simply provide an article identifier and we\'ll process it for you.' %}</p>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <div>
          <h4 style="color: #333; margin-bottom: 10px;">{% trans 'What is a DOI?' %}</h4>
          <p style="font-size: 14px; color: #666; margin-bottom: 0;">{% trans 'A DOI (Digital Object Identifier) is a unique code that identifies scientific articles. It usually starts with "10." and looks like: 10.1016/j.cell.2020.01.001' %}</p>
        </div>
        <div>
          <h4 style="color: #333; margin-bottom: 10px;">{% trans 'What is a PMID?' %}</h4>
          <p style="font-size: 14px; color: #666; margin-bottom: 0;">{% trans 'A PMID (PubMed ID) is a number assigned to articles in the PubMed database. It\'s usually 7-8 digits long, like: 32109414' %}</p>
        </div>
      </div>
    </div>

    <!-- Quick demo examples section -->
    <div class="demo-examples-section" style="margin-bottom: 30px;">
      <h3 style="color: var(--primary-color); margin-bottom: 15px;">{% trans 'Try these examples' %}</h3>
      <p style="color: #666; margin-bottom: 20px; font-size: 14px;">{% trans 'Click any example below to automatically fill in the form and try it out:' %}</p>
      
      <div class="demo-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
        <div class="demo-card" data-type="DOI" data-value="10.1016/j.isci.2019.100776" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s ease; background: white;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
            <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">DOI</span>
            <span style="color: #28a745; font-size: 12px; margin-left: auto;">{% trans 'Click to use' %}</span>
          </div>
          <code style="font-size: 14px; color: #495057; word-break: break-all;">10.1016/j.isci.2019.100776</code>
          <p style="font-size: 12px; color: #6c757d; margin: 8px 0 0 0;">{% trans 'Cell biology research article' %}</p>
        </div>
        
        <div class="demo-card" data-type="DOI" data-value="10.1007/978-1-4939-6371-3_18" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s ease; background: white;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
            <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">DOI</span>
            <span style="color: #28a745; font-size: 12px; margin-left: auto;">{% trans 'Click to use' %}</span>
          </div>
          <code style="font-size: 14px; color: #495057; word-break: break-all;">10.1007/978-1-4939-6371-3_18</code>
          <p style="font-size: 12px; color: #6c757d; margin: 8px 0 0 0;">{% trans 'Methods in molecular biology' %}</p>
        </div>
        
        <div class="demo-card" data-type="DOI" data-value="10.1016/j.cmet.2009.11.010" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s ease; background: white;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
            <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">DOI</span>
            <span style="color: #28a745; font-size: 12px; margin-left: auto;">{% trans 'Click to use' %}</span>
          </div>
          <code style="font-size: 14px; color: #495057; word-break: break-all;">10.1016/j.cmet.2009.11.010</code>
          <p style="font-size: 12px; color: #6c757d; margin: 8px 0 0 0;">{% trans 'Metabolism research article' %}</p>
        </div>
      </div>
    </div>

    <!-- Main form section -->
    <div class="form-section" style="background: white; padding: 25px; border-radius: 8px; border: 1px solid #dee2e6;">
      <h3 style="color: var(--primary-color); margin-top: 0; margin-bottom: 20px;">{% trans 'Enter Article Information' %}</h3>
      
      <form id="articleProcessForm" style="margin-bottom: 20px">
        <div style="margin-bottom: 20px;">
          <label for="identifier_type" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">{% trans 'Identifier Type:' %}</label>
          <select id="identifier_type" name="type" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px; background: white;">
            <option value="DOI" selected>DOI (Digital Object Identifier)</option>
            <option value="PMID">PMID (PubMed ID)</option>
            {% comment %}
            <option value="ARXIV">ARXIV ID</option>
            {% endcomment %}
          </select>
        </div>
        
        <div style="margin-bottom: 25px;">
          <label for="identifier_value" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">{% trans 'Identifier Value:' %}</label>
          <div style="position: relative;">
            <input type="text" id="identifier_value" name="identifier" placeholder="{% trans 'e.g., 10.1038/nature12373 or try one of the examples above' %}" required style="width: 100%; padding: 12px 50px 12px 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px; transition: border-color 0.2s ease;" />
            <button type="button" id="clear-input" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6c757d; cursor: pointer; padding: 5px; display: none;" title="{% trans 'Clear input' %}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <small style="color: #6c757d; font-size: 13px; margin-top: 5px; display: block;">{% trans 'Supported sources: PubMed, Europe PMC, bioRxiv, medRxiv' %}</small>
        </div>
        
        <button type="submit" class="primary-button" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 500;">{% trans 'Start Processing Article' %}</button>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  const notificationsDivSubmit = document.getElementById("notifications"); // Указывает на новый #notifications

  const notificationsDiv = document.getElementById("notifications");
  const articleProcessForm = document.getElementById("articleProcessForm");
  const identifierValueInput = document.getElementById("identifier_value");
  const identifierTypeSelect = document.getElementById("identifier_type");
  const currentUserId = "{{ user_id }}"; // Получаем из контекста Django

  // --- WebSocket для уведомлений ---
  let ws_protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
  let ws_url = `${ws_protocol}//${window.location.host}/ws/notifications/`;
  let socket;

  function connectWebSocket() {
    if (!currentUserId || currentUserId === "None") {
      console.warn("User is not authenticated, WebSocket will not be connected.");
      notificationsDiv.innerHTML = '<div class="status-WARNING">You are not authenticated. Notifications will not be received.</div>';
      return;
    }

    console.log(`Attempting to connect WebSocket to ${ws_url} for user ${currentUserId}`);
    socket = new WebSocket(ws_url);

    socket.onopen = function (e) {
      console.log("WebSocket connection established.");
      addNotification({ payload: { status: "INFO", message: "WebSocket connection established." } });
    };

    socket.onmessage = function (event) {
      const data = JSON.parse(event.data);
      console.log("Received WebSocket message:", data);
      addNotification(data);
    };

    socket.onclose = function (event) {
      console.error("WebSocket connection closed:", event);
      let reason = "";
      if (event.reason) {
        reason = ` Reason: ${event.reason}`;
      }
      addNotification({ payload: { status: "FAILURE", message: `WebSocket connection closed. Code: ${event.code}.${reason}` } });
      // Attempt to reconnect in 5 seconds if the user is still on the page
      setTimeout(connectWebSocket, 5000);
    };

    socket.onerror = function (error) {
      console.error("WebSocket error:", error);
      addNotification({ payload: { status: "FAILURE", message: "WebSocket connection error." } });
    };
  }

  function addNotification(data) {
    // Это функция для submit_article.html
    const initialMsgSubmit = notificationsDivSubmit.querySelector('p[style*="text-align: center"]');
    if (initialMsgSubmit) {
      initialMsgSubmit.remove();
    }
    let notificationHtml = `<div class="status-${data.payload?.status || "INFO"}">`;
    if (data.type === "connection_established") {
      notificationHtml += `<strong>${data.message || data.payload?.message}</strong>`;
    } else if (data.type === "task_notification" && data.payload) {
      const p = data.payload;
      notificationHtml += `<strong>Task [${p.task_id || "N/A"}] for ${p.source_api || "Source"} (${p.identifier || "N/A"})</strong><br>`;
      notificationHtml += `Status: ${p.status}<br>`;
      notificationHtml += `Message: ${p.message}<br>`;
      if (p.progress_percent !== undefined) {
        notificationHtml += `Progress: ${p.progress_percent}%<br>`;
      }
      if (p.article_id) {
        notificationHtml += `Article ID: ${p.article_id} (Created: ${p.created === undefined ? "N/A" : p.created})<br>`;
      }
    } else if (data.payload) {
      notificationHtml += `<strong>${data.payload.source_api || "System"} (${data.payload.identifier || "N/A"})</strong><br>`;
      notificationHtml += `Status: ${data.payload.status}<br>`;
      notificationHtml += `Message: ${data.payload.message}<br>`;
      if (data.payload.progress_percent !== undefined) {
        notificationHtml += `Progress: ${data.payload.progress_percent}%<br>`;
      }
    } else {
      notificationHtml += JSON.stringify(data);
    }
    notificationHtml += `</div>`;
    notificationsDivSubmit.insertAdjacentHTML("afterbegin", notificationHtml);
  }

  // Подключаем WebSocket при загрузке страницы
  connectWebSocket();

  // --- Interactive Demo Cards ---
  const demoCards = document.querySelectorAll('.demo-card');
  const clearButton = document.getElementById('clear-input');

  // Add click handlers for demo cards
  demoCards.forEach(card => {
    card.addEventListener('click', function() {
      const type = this.dataset.type;
      const value = this.dataset.value;
      
      // Set the form values
      identifierTypeSelect.value = type;
      identifierValueInput.value = value;
      
      // Add visual feedback
      this.style.borderColor = 'var(--primary-color)';
      this.style.backgroundColor = '#f8f9ff';
      
      // Reset other cards
      demoCards.forEach(otherCard => {
        if (otherCard !== this) {
          otherCard.style.borderColor = '#e9ecef';
          otherCard.style.backgroundColor = 'white';
        }
      });
      
      // Show clear button
      clearButton.style.display = 'block';
      
      // Focus the input field and scroll to form
      identifierValueInput.focus();
      document.querySelector('.form-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
      
      // Add a subtle success message
      const successMsg = document.createElement('div');
      successMsg.textContent = 'Example loaded! You can now click "Start Processing" or modify the identifier.';
      successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 14px; border: 1px solid #c3e6cb;';
      
      // Remove any existing success message
      const existingMsg = document.querySelector('.demo-success-msg');
      if (existingMsg) existingMsg.remove();
      
      successMsg.className = 'demo-success-msg';
      document.querySelector('.form-section').appendChild(successMsg);
      
      // Remove success message after 4 seconds
      setTimeout(() => {
        if (successMsg.parentNode) {
          successMsg.remove();
        }
      }, 4000);
    });
    
    // Add hover effects
    card.addEventListener('mouseenter', function() {
      if (this.style.borderColor !== 'var(--primary-color)') {
        this.style.borderColor = '#007bff';
        this.style.backgroundColor = '#f8f9ff';
      }
    });
    
    card.addEventListener('mouseleave', function() {
      if (this.style.borderColor !== 'var(--primary-color)') {
        this.style.borderColor = '#e9ecef';
        this.style.backgroundColor = 'white';
      }
    });
  });

  // Clear button functionality
  clearButton.addEventListener('click', function() {
    identifierValueInput.value = '';
    this.style.display = 'none';
    
    // Reset all demo cards
    demoCards.forEach(card => {
      card.style.borderColor = '#e9ecef';
      card.style.backgroundColor = 'white';
    });
    
    // Remove success message if present
    const successMsg = document.querySelector('.demo-success-msg');
    if (successMsg) successMsg.remove();
    
    identifierValueInput.focus();
  });

  // Show/hide clear button based on input content
  identifierValueInput.addEventListener('input', function() {
    if (this.value.trim()) {
      clearButton.style.display = 'block';
    } else {
      clearButton.style.display = 'none';
    }
  });

  // Enhanced input field styling on focus
  identifierValueInput.addEventListener('focus', function() {
    this.style.borderColor = 'var(--primary-color)';
    this.style.boxShadow = '0 0 0 3px rgba(79, 70, 229, 0.1)';
  });

  identifierValueInput.addEventListener('blur', function() {
    this.style.borderColor = '#e9ecef';
    this.style.boxShadow = 'none';
  });

  // --- Обработка формы ---
  articleProcessForm.addEventListener("submit", function (event) {
    event.preventDefault();
    const identifierValue = identifierValueInput.value.trim();
    const identifierType = identifierTypeSelect.value;

    if (identifierValue) {
      addNotification({ payload: { status: "INFO", message: `Sending request to process ${identifierType}: ${identifierValue}...` } });

      // Using the API that triggers the dispatcher task
      fetch(`/api/articles/process-article/?identifier=${encodeURIComponent(identifierValue)}&type=${encodeURIComponent(identifierType)}`)
        .then((response) => {
          if (!response.ok) {
            // Attempt to read the error body, if available
            return response.json().then((errData) => {
              throw new Error(`Server error: ${response.status}. ${errData.error || JSON.stringify(errData)}`);
            });
          }
          return response.json();
        })
        .then((data) => {
          console.log("Response from process-article API:", data);
          if (data.pipeline_task_id) {
            addNotification({ payload: { status: "SUCCESS", message: `Processing pipeline started. Task ID: ${data.pipeline_task_id}` } });
          } else {
            addNotification({ payload: { status: "FAILURE", message: `Error starting pipeline: ${data.error || JSON.stringify(data)}` } });
          }
        })
        .catch((error) => {
          console.error("Error calling process-article API:", error);
          addNotification({ payload: { status: "FAILURE", message: `API call error: ${error.message}` } });
        });
    }
  });
</script>
{% endblock %}
